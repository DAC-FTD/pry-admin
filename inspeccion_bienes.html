<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Determinación de bienes para Proceso Baja</title>
    <link rel="icon" type="image/png" href="img/logo-unemi.png">
       <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    

    <style>
        body {
            font-family: 'Roboto','Open Sans', Arial, sans-serif;
            background-color: #ffffff;
            color: #1D2B4F;
        }
         .logo-tigre {
            height: 60px;
            object-fit: contain;
           
        }
        .logo-unemi {
            height: 50px;
            object-fit: contain;
           
        }
        .franja-superior {
            background-color: #1D2B4F;
            color: white;
            font-size: 20px;
            font-weight: bold;
            vertical-align: middle;
        }
        .franja-naranja {
            height: 10px;
            background-color: #F39200;
        }
        .btngb {
            color: #ffffff;
            border: none;
            border-radius: 5px;

        }
        .btngd {
            background-color: #F39200;
            color: #ffffff;
            border: none;
            border-radius: 5px;

        }
        .btngb:hover {
            background-color: #063970;
            color: white;
        }
        .btngd:hover {
            background-color: #d97e00;
            color: white;
        }
        
 
        #tablaBienes td, #tablaBienes th {
        padding: 8px;
        vertical-align: middle;
        text-align: center;
        color: #1D2B4F;
      }
        #tablaBienes tbody td {
            font-size: 12px;!important; /* Tamaño reducido para el cuerpo de la tabla */
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

    </style>
</head>
<body>

<!-- Encabezado -->
<div class="franja-superior d-flex justify-content-between align-items-center px-3">
    <!-- Izquierda -->
    <div class="d-flex align-items-center">
        <img src="img/logo-unemi.png" alt="Logo" class="logo-tigre">
    </div>

    <!-- Centro -->
    <div class="text-center">
        <h2 style="color:white;" class="fw-bold">Determinación de bienes para Proceso Baja</h2>
    </div>

    <!-- Derecha -->
    <div class="d-flex align-items-center justify-content-end">
        <img src="img/unemi-logo.png" alt="Logo" class="logo-unemi">
    </div>
</div>
<div class="franja-naranja"></div>

<div class="container mt-12">

    <div class="row align-items-center mt-3">
    <!-- Columna Izquierda -->
    <div class="col-md-6 d-flex align-items-center">
        <select id="selectorTipoBaja" class="form-select me-2" style="width: auto;">
            <option value="">Seleccione tipo de baja</option>
            <option value="Chatarrización">Chatarrización</option>
            <option value="Remate">Remate</option>
            <option value="Transferencia">Transferencia</option>
        </select>
        <button id="btnAplicarSeleccion" class="btn btn-primary btn-sm" onclick="AplicarSeleccion()">Aplicar a seleccionados</button>
    </div>

    <!-- Columna Derecha -->
    <div class="col-md-6 d-flex justify-content-end align-items-center">
        <button class="btn btn-primary btn-sm btngb me-2 " onclick="guardarBorrador()">Guardar borrador</button>
        <button class="btn btn-primary btn-sm btngd" onclick="guardarDatos()">Finalizar proceso</button>
    </div>
</div>

    <h6 class="fw-bold mb-0 mt-3">Listado de bienes</h6>
     <div class="card shadow-sm mb-3 mt-1">
        <div class="card-body">
            <div class="table-responsive-lg">
                <table id="tablaBienes" class="table table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th><input type="checkbox" id="checkAll"></th> <!-- Check para seleccionar todos -->
                            <th>Código gobierno</th>
                            <th>Código interno</th>
                            <th>Bien</th>
                            <th>Descripción</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Estado</th>
                            <th>Condición</th>
                            <th>Tipo de Baja</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Datos dinámicos -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

 
</div>

<script> 

document.getElementById('checkAll').addEventListener('click', function() {
    const checked = this.checked;
    document.querySelectorAll('.checkBien').forEach(c => c.checked = checked);
});


function actualizarMatriz() {
     fetch('https://hook.us2.make.com/a6iqx6iilho1b8k1vt2s2l65oewtcmyp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ origen: "act_matriz" })
        })
        .then(response => response.json())
        .then(data => {
            if (data.estado === 'procesados') {
            // Mostrar alerta
                Swal.fire({
                    icon: 'info',
                    title: 'Sin procesos pendientes',
                    text: 'No existen bienes por procesar. Esta pantalla se encuentra bloqueada.',
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
            }

            else{
            const tbody = document.querySelector('#tablaBienes tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const fila = document.createElement('tr');
                fila.dataset.estado = item.estado;
                const tipoBaja = item.tipo_baja || ' ';
                fila.innerHTML = `
                    <td><input type="checkbox" class="checkBien"></td>
                    <td>${item.codigo_gobierno}</td>
                    <td>${item.codigo_interno}</td>
                    <td>${item.bien}</td>
                    <td>${item.descripcion}</td>
                    <td>${item.marca}</td>
                    <td>${item.modelo}</td>
                    <td>${item.estado}</td>
                    <td>${item.condicion}</td>
                    <td>
                        <select class="form-select tipo-baja-select">
                            <option value="">Seleccione...</option>
                            <option value="Chatarrización" ${tipoBaja === 'Chatarrización' ? 'selected' : ''}>Chatarrización</option>
                            <option value="Transferencia" ${tipoBaja === 'Transferencia' ? 'selected' : ''}>Transferencia</option>
                            <option value="Remate" ${tipoBaja === 'Remate' ? 'selected' : ''}>Remate</option>
                        </select>
                    </td>

                `;
                tbody.appendChild(fila);
            });

            var table = $('#tablaBienes').DataTable({
                destroy: true,
                pageLength: 20,
                lengthChange: false,
                ordering: false,
                orderCellsTop: true,
                fixedHeader: true,
                language: {
                search: "Buscar:",
                zeroRecords: "No se encontraron registros",
                info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                paginate: {
                    first: "Primero",
                    last: "Último",
                    next: "Siguiente",
                    previous: "Anterior"
                    }
                }   
            });

            $('.tipo-baja-select').select2({
                width: '100%',
                placeholder: "Seleccione...",
                dropdownAutoWidth: true
            });

            table.on('draw', function() {
                // Solo inicializar Select2 en los selects que NO tengan ya el atributo "select2-hidden-accessible"
                $('#tablaBienes tbody .tipo-baja-select').each(function() {
                    if (!$(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2({
                            width: '100%',
                            placeholder: "Seleccione...",
                            dropdownAutoWidth: true
                        });
                    }
                });
            });
            } 

        })
        .catch(error => Swal.fire('Error', 'No se cargaron los datos.', 'error'));
}

function guardarBorrador() {
    const table = $('#tablaBienes').DataTable(); // Obtener instancia de DataTable
    const allData = table.rows().data(); // Obtener todos los datos de todas las páginas

    const datos = [];

    allData.each(function (rowData, index) {
        const rowNode = table.row(index).node(); // Obtener el nodo real del <tr>
        const celdas = rowNode.querySelectorAll('td');

        const codigoGobierno = celdas[1]?.innerText.trim();
        const tipoBajaSelect = celdas[9]?.querySelector('select');

        if (codigoGobierno && tipoBajaSelect) {
            datos.push({
                origen:"borrador",
                codigo_gobierno: codigoGobierno,
                tipo_baja: tipoBajaSelect.value.trim()
            });
        }
    });

    fetch('https://hook.us2.make.com/a6iqx6iilho1b8k1vt2s2l65oewtcmyp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bienes: datos })
    })
    .then(response =>Swal.fire({icon: 'success',title: 'Éxito',text: 'Borrador guardado exitosamente.',timer: 2000,showConfirmButton: false}))
    .catch(error => Swal.fire('Error', 'Error en la conexión al guardar el borrador.', 'error'));
}

function AplicarSeleccion() {
    const tipoSeleccionado = document.getElementById('selectorTipoBaja').value;

    if (!tipoSeleccionado) {
        Swal.fire('Advertencia', 'Debe seleccionar un tipo de baja.', 'warning');
        return;
    }

    let cambiosRealizados = false;

    // Recorrer todos los checks seleccionados
    document.querySelectorAll('.checkBien:checked').forEach(check => {
        const fila = check.closest('tr');
        
        // Buscar el select dentro de la fila
        const selectTipoBaja = fila.querySelector('select');

        if (selectTipoBaja) {
            selectTipoBaja.value = tipoSeleccionado; // 🔥 Cambiamos el valor directamente del <select>
            selectTipoBaja.dispatchEvent(new Event('change')); // 🔥 Forzamos que el navegador "dibuje" el cambio
            cambiosRealizados = true;
        }
    });

    if (cambiosRealizados) {
        guardarBorrador();
         //  1. Reiniciar todos los checkboxes
        document.querySelectorAll('.checkBien').forEach(check => check.checked = false);
        //  2. Reiniciar el combo general de tipo de baja
        document.getElementById('selectorTipoBaja').value = '';
    } else {
        Swal.fire('Advertencia', 'No seleccionó ningún registro.', 'warning');
    }
}
    
function guardarDatos() {
    const table = $('#tablaBienes').DataTable();
    const allData = table.rows().data();
    const datos = [];
    let hayFaltantes = false;

    allData.each(function (rowData, index) {
        const rowNode = table.row(index).node(); //  Accede al <tr> completo
        const celdas = rowNode.querySelectorAll('td');
        const tipoBajaSelect = celdas[9]?.querySelector('select');
        const tipoBajaValor = tipoBajaSelect ? tipoBajaSelect.value.trim() : '';

        if (!tipoBajaValor) {
            hayFaltantes = true;
        }

        datos.push({
            origen: "reportes",
            codigo_gobierno: celdas[1]?.innerText.trim(),
            codigo_interno: celdas[2]?.innerText.trim(),
            bien: celdas[3]?.innerText.trim(),
            descripcion: celdas[4]?.innerText.trim(),
            marca: celdas[5]?.innerText.trim(),
            modelo: celdas[6]?.innerText.trim(),
            estado: celdas[7]?.innerText.trim(),
            condicion: celdas[8]?.innerText.trim(),
            tipo_baja: tipoBajaValor
        });
    });

    //  Validación: mostrar error si falta algún tipo de baja
    if (hayFaltantes) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos incompletos',
            text: 'Debe asignar un tipo de baja a todos los bienes antes de finalizar el proceso.'
        });
        return;
    }

    // ✅ Mostrar loader
    document.getElementById('loader-overlay').style.display = 'flex';


    // Envío si todo está correcto
    fetch('https://hook.us2.make.com/a6iqx6iilho1b8k1vt2s2l65oewtcmyp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bienes: datos })
    })
    .then(data => {
        Swal.fire({
            icon: 'success',
            title: 'Éxito',
            text: 'Proceso finalizado exitosamente.',
            timer: 2000,
            showConfirmButton: false
        });
        // ✅ Ocultar loader al recibir respuesta
        document.getElementById('loader-overlay').style.display = 'none';
        location.reload();
    })
    .catch(error => {
        Swal.fire('Error', error.message, 'error');
    });
}

window.onload = actualizarMatriz;
</script>

<div id="loader-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <img src="img/tigrillo.gif" alt="Cargando..." style="width: 250; height: 250px;">
</div>

</body>
</html>
